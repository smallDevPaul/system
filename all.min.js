var system,trim,trimTo,Vector,Rectangle,Circle,Segment,Traingle,Polygon,Point,IO,GeometryJS;trim=function(t){return t.replace(/\s+/gi,"")},trimTo=function(t,e){return e.replace(/\s+/gi,t)},Object.prototype.extend=function(t){for(p in t)this[p]=t[p];return this},Object.prototype.extend({is:function(){var t;return t=Object.prototype.toString.call(this),t=t.slice(8,t.length-1),0!==arguments.length?t===arguments[0]:t},hasProp:function(t){return t in this}}),system={canvas:{},world:{},event:{},hub:{background:{used:!1}},init:function(t,e,i,s){return this.canvas=document.getElementById(t),this.world=this.canvas.getContext("2d"),system.hub.clearingEnabled=null!=s?s:!0,arguments.length>2?(this.canvas.width=e,this.canvas.height=i):null!=e&&(system.hub.clearingEnabled=e),this.width=this.canvas.width,this.height=this.canvas.height,this.world},cursor:function(t){return{y:t.y-+system.hub.offsetY,x:t.x-+system.hub.offsetX}},fullWH:function(t){var e;e=function(){system.width=system.canvas.width=window.innerWidth,system.height=system.canvas.height=window.innerHeight},t&&t.is("Function")&&!arguments[1]?window.addEventListener("resize",function(i){e(),t(i)}):t||window.addEventListener("resize",e),e()},set:function(t){this.world.extend(t)},center:function(t){var e=function(){var t=system.width,e=system.heigh,i=window.innerWidth,s=window.innerHeight;t>i||e>s||(system.hub.offsetY=system.canvas.style.marginTop=""+(i-t)/2,system.hub.offsetX=system.canvas.style.marginRight=""+(s-e)/2)};t||window.addEventListener("resize",e,!0),e()},use:function(t,e){t.match(/key/gi)?window["on"+t]=e:this.canvas["on"+t]=e},unuse:function(t){this.use(t,null)},on:function(t,e,i){i=!!i,this.event.hasProp(t)||(this.event[t]=[]),this.event[t].push({handler:e,capture:i}),t.match(/key/gi)||"mousemove"===t||"mousewheel"===t?window.addEventListener(t,e,i):this.canvas.addEventListener(t,e,i)},off:function(t,e){var i;null==e&&(e=0),i=this.event[t],t.match(/key/gi)?window.removeEventListener(t,i[e].handler,i[e].capture):this.canvas.removeEventListener(t,i[e].handler,i[e].capture),this.event[t].splice(e,1)},run:function(t){this.timer=setInterval(function(){if(system.hub.clearingEnabled&&system.clear(),system.hub.background.used){var e=!1;"alpha"in system.hub.background&&(e=!0,system.set({globalAlpha:system.hub.background.alpha})),system.set({fillStyle:system.hub.background.pattern}),system.world.fillRect(0,0,system.width,system.height),e&&system.set({globalAlpha:"1"})}t()})},clear:function(){system.world.clearRect(0,0,this.width,this.height)},stop:function(){clearInterval(this.timer,100/6)},background:function(t,e){var i=system.hub.background;i.used=!0,i.pattern=t,null!=e&&(i.alpha=e)},image:{pattern:function(t,e){var i;return i=new Image,i.src=t,{to:function(t){i.onload=function(){t(system.world.createPattern(i,e))}}}},bitmap:function(t){var e,i;return i=arguments,e=new Image,e.src=t,i[0]=e,{to:function(t){e.onload=function(){var e;e=createImageBitmap.apply(window,i).then(t)}}}}},opacity:function(t){return this.world.globalAlpha=t,this}};system.gameObjects=[];Vector=function(t,e){this.x=t,this.y=e},Point=function(){Vector.apply(this,arguments),this.index=system.gameObjects.length,system.gameObjects.push(this)},Rectangle=function(t,e,i,s){if(system.gameObjects.push(this),this.index=system.gameObjects.length-1,this.vertex=[],arguments.length>4){var n=arguments;this.vertex[0]=new Vector(t,e,!0),this.vertex[1]=new Vector(n[2],n[3],!0),this.vertex[2]=new Vector(n[4],n[5],!0),this.vertex[3]=new Vector(n[6],n[7],!0)}else this.vertex[0]=new Vector(t,e,!0),this.vertex[1]=new Vector(t,e+s,!0),this.vertex[2]=new Vector(t+i,e+s,!0),this.vertex[3]=new Vector(t+i,e,!0)},Circle=function(t,e,i){system.gameObjects.push(this),this.index=system.gameObjects.length-1,this.c=new Vector(t,e,!0),this.radius=i},Segment=function(t,e,i){system.gameObjects.push(this),this.index=system.gameObjects.length-1,this.point=[],arguments.length>3?(this.point[0]=new Vector(t,e,!0),this.point[1]=new Vector(i,arguments[3],!0)):(this.point[0]=new Vector(t,e,!0),this.point[1]=new Vector(t+i,e,!0))},IO=function(t,e,i,s,n){system.gameObjects.push(this),this.index=system.gameObjects.length-1,this.path=t,this.image=new Image,this.x=e,this.y=i,null!=s&&null!=n&&(this.width=s,this.height=n),this.loaded=!1;var r=this;this.image.onload=function(){r.loaded=!0},this.image.src=t},Polygon=function(t){system.gameObjects.push(this),this.index=system.gameObjects.length-1,this.vertex=[];for(var e=0,i=0,s=t.length;s>i;e++,i+=2)this.vertex[e]=new Vector(t[i],t[i+1],!0);this.RP=0},Vector.prototype.extend({distance_to:function(t){return Math.sqrt(Math.pow(this.x-t.x,2)+Math.pow(this.y-t.y,2))},move:function(t,e){this.x+=t,this.y+=e},replace:function(t,e){this.x=t,this.y=e}}),Point.prototype.extend(Vector.prototype),Point.prototype.constructor=Point,Rectangle.prototype.extend({width:function(){return this.vertex[0].distance_to(this.vertex[3])},height:function(){return this.vertex[0].distance_to(this.vertex[1])},has_point:function(t){return this.vertex[0].x>t.x||this.vertex[0].y>t.y||this.vertex[2].x<t.x||this.vertex[2].y<t.y?!1:!0},scale:function(t){var e=(this.height()*t-this.height())/2,i=(this.width()*t-this.width())/2;this.vertex[0].move(-i,-e),this.vertex[1].move(-i,e),this.vertex[2].move(i,e),this.vertex[3].move(i,-e)},move:function(t,e){for(var i=0;4>i;i++)this.vertex[i].move(t,e)},replace:function(t,e){this.move(t-this.vertex[0].x,e-this.vertex[0].y)},rect_collision:function(t){for(var e=0;4>e;e++)if(this.has_point(t.vertex[e]))return!0;for(var e=0;4>e;e++)if(t.has_point(this.vertex[e]))return!0;return!1},circle_collision:function(t,e){if(this.has_point(t.c))e(-1);else{var i;sw=!1,t.c.y<this.vertex[0].y?t.c.x<this.vertex[0].x?i=this.vertex[0]:t.c.x>this.vertex[3].x?i=this.vertex[3]:(t.c.y+t.radius<this.vertex[0].y||e(0),sw=!0):t.c.y>this.vertex[1].y?t.c.x<this.vertex[1].x?i=this.vertex[1]:t.c.x>this.vertex[2].x?i=this.vertex[2]:(t.c.y-t.radius>this.vertex[1].y||e(2),sw=!0):(sw=!0,t.c.x<this.vertex[0].x&&t.c.x+t.radius>=this.vertex[0].x?e(1):t.c.x>this.vertex[2].x&&t.c.x-t.radius<=this.vertex[2].x&&e(3)),sw||i.distance_to(t.c)>t.radius||e(4)}}}),Segment.prototype.extend({length:function(){return this.point[0].distance_to(this.point[1])},move:function(t,e){this.point[0].move(t,e),this.point[1].move(t,e)},scale:function(t){var e=this.length();if(e=(e*t-e)/2,this.point[0].y===this.point[1].y)this.point[0].move(-e,0),this.point[0].move(e,0);else{var i,s,n,r;i=new Vector(this.point[0].x,this.point[1].y),s=this.point[0].distance_to(i),n=this.point[1].distance_to(i),r=this.length(),e=new Vector(s/r*e),this.point[0].y>this.point[1].y&&(e=-e),this.point[0].move(-e,-e),this.point[1].move(e,e)}},circle_collision:function(t){if(t.c.x>this.point[0].x&&t.c.x<this.point[1].x){var e,i,s,n;if(e=this.point[0].distance_to(t.c),i=this.point[1].distance_to(t.c),s=this.length(),n=(e+i+s)/2,2*Math.sqrt(n*(n-e)*(n-i)*(n-s))/s<=t.radius)return!0}else if(t.c.x>this.point[0].x){if(t.c.distance_to(this.point[1])<=t.radius)return!0}else if(t.c.distance_to(this.point[0])<=t.radius)return!0;return!1}}),Circle.prototype.extend({rect_collision:function(t,e){t.circle_collision(this,e)},segment_collision:function(t){return t.circle_collision(this)},has_point:function(t){return t.distance_to(this.c)>this.radius?!1:!0},move:function(t,e){this.c.move(t,e)},replace:function(t,e){this.c.replace(t,e)},scale:function(t){this.radius*=t}}),IO.prototype.extend({draw:function(t,e,i,s){var n;null==t?(n=[this.image,this.x,this.y],this.hasProp("width")&&(n.push(this.width),n.push(this.height))):n=[this.image,t,e,i,s,this.x,this.y,this.width,this.height],system.world.drawImage.apply(system.world,n)},move:function(t,e){this.x+=t,this.y+=e},replace:function(t,e){this.x=t,this.y=e},scale:function(t){this.width*=t,this.height*=t},getOriginSize:function(){return{width:this.image.width,height:this.image.height}},onload:function(t){this.image.onload=t}}),Polygon.prototype.extend({setReplacePoint:function(t){this.RP=t},move:function(t,e){this.vertex.map(function(i){i.move(t,e)})},replace:function(t,e){var i,s;i=Math.abs(this.vertex[this.RP].x-t),s=Math.abs(this.vertex[this.RP].y-e);for(var n=0,r=this.vertex.length;r>n;n++)this.vertex[n].move(i,s)}}),system.camera={vx:0,vy:0,move:function(t,e){this.vx+=t,this.vy+=e,system.gameObjects.map(function(i){i.move(t,e)})},reset:function(t,e){this.vx=null!=t?t:0,this.vy=null!=e?t:0},allowFor:function(t){t.index=system.world.length,system.gameObjects.push(t)},preventFor:function(t){system.gameObjects.splice(t.index,1),t.index=void 0}},system.brush={_call:function(t){var e=t.substring(2,t.length-1);e=e.split(","),"M"===t[0]?system.world.moveTo(e[0],e[1]):"L"===t[0]?system.world.lineTo(e[0],e[1]):"A"===t[0]?system.world.arc(e[0],e[1],e[2],e[3],e[4],!!parseInt(e[5])):"F"===t[0]?system.world.fill():"S"===t[0]?system.world.stroke():!1},frect:function(t,e,i,s,n){var r=system.world;return n&&(r.fillStyle=n),r.fillRect(t,e,i,s),this},srect:function(t,e,i,s,n){var r=system.world;return n&&(r.strokeStyle=n),r.strokeRect(t,e,i,s),this},farc:function(t,e,i,s,n,r,h){var o=system.world;return o.beginPath(),r&&(o.fillStyle=r),o.arc(t,e,i,s,n,!!h),o.fill(),o.closePath(),this},sarc:function(t,e,i,s,n,r,h){var o=system.world;return o.beginPath(),r&&(o.strokeStyle=r),o.arc(t,e,i,s,n,!!h),o.stroke(),o.closePath(),this},fcircle:function(t,e,i,s){return this.farc(t,e,i,0,2*Math.PI,s),this},scircle:function(t,e,i,s){return this.sarc(t,e,i,0,2*Math.PI,s),this},line:function(t,e,i,s){var n=system.world;return n.beginPath(),n.moveTo(t,e),null==s?n.lineTo(t+i,e):n.lineTo(i,s),n.stroke(),n.closePath(),this},path:function(t){var e;trimTo(" ",t),e=t.split(" "),system.world.beginPath();for(var i=0,s=e.length;s>i;i++)this._call(e[i]);return system.world.closePath(),this},image:function(){system.world.drawImage.aplly(system.world,arguments)}},window.hasProp("GeometryJS")&&(Rectangle.prototype.extend({style:function(t){this.hasProp("SO")||(this.SO={}),this.SO.extend(t)},fill:function(){var t=system.world;t.fillStyle=this.SO.fillStyle,t.fillRect(this.vertex[0].x,this.vertex[0].y,this.width(),this.height())},stroke:function(){var t=system.world;t.strokeStyle=this.SO.strokeStyle,t.strokeRect(this.vertex[0].x,this.vertex[0].y,this.width(),this.height())},draw:function(){var t=system.world,e=this.width(),i=this.height();t.extend(this.SO),t.fillRect(this.vertex[0].x,this.vertex[0].y,e,i),t.strokeRect(this.vertex[0].x,this.vertex[0].y,e,i)}}),Point.prototype.extend({style:function(t){return this.SO={fillStyle:t},this},draw:function(){var t=system.world;t.beginPath(),t.extend(this.SO),t.arc(this.x,this.y,1,0,2*Math.PI,!1),t.closePath()}}),Circle.prototype.style=Rectangle.prototype.style,Circle.prototype.extend({fill:function(){system.brush.fcircle(this.c.x,this.c.y,this.radius,this.SO.fillStyle)},stroke:function(){system.brush.scircle(this.c.x,this.c.y,this.radius,this.SO.strokeStyle)},draw:function(){var t=system.world;t.beginPath(),t.extend(this.SO),t.arc(this.c.x,this.c.y,this.radius,0,2*Math.PI,!1),t.fill(),t.stroke(),t.closePath()}}),Segment.prototype.extend({style:function(t){this.hasProp("SO")||(this.SO={}),this.SO.strokeStyle=t},draw:function(){var t=system.world;t.beginPath(),t.extend(this.SO),t.moveTo(this.point[0].x,this.point[0].y),t.lineTo(this.point[1].x,this.point[1].y),t.stroke(),t.closePath()}})),Point.prototype.extend({style:function(t){return this.FS=t,this},draw:function(){var t=system.world;t.beginPath(),t.fillStyle=this.FS,t.arc(this.x,this.y,1,0,2*Math.PI,!1),t.fill(),t.closePath()}});